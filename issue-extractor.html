<!doctype html>
<html lang="en">
    <head>
        <title>Issue extractor</title>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <style>
            #container {
                display: flex;
                flex-direction: column;
            }

            #inputs,
            #results {
                flex: 1;
                padding: 10px;
            }

            #results div {
                margin-bottom: 10px;
            }

            @media (min-width: 600px) {
                #container {
                    flex-direction: row;
                }
            }
        </style>
        <script src="compress.min.js"></script>
    </head>

    <body>
        <div id="container">
            <div id="inputs">
                <label for="regex">Issue Key Regex:</label>
                <input
                    name="regex"
                    id="regex"
                    type="text"
                    placeholder="Enter issue regex here..."
                    value="IX-[0-9]{6}"
                /><br />
                <label for="extractionText"
                    >Text to extract the issue from:</label
                ><br />
                <textarea
                    name="extractionText"
                    id="extractionText"
                    rows="20"
                    cols="70"
                    placeholder="Enter text that contains issues here..."
                    autocomplete="off"
                >
                </textarea>
            </div>
            <div id="results">
                <div><span> Number of issues: </span><b id="number">0</b></div>
                <div>
                    <label for="jql">JQL:</label>
                    <input
                        name="jql"
                        id="jql"
                        type="text"
                        readonly
                        style="width: 400px"
                        autocomplete="off"
                    />
                    <button onclick="copyJql()">Copy to clipboard</button>
                </div>
                <div>
                    <label>Found issues:</label>
                    <ul id="issues"></ul>
                </div>
            </div>
        </div>
        <script>
            const regex = document.getElementById("regex");
            const text = document.getElementById("extractionText");

            let issues = [];

            function findIssues() {
                const matches = text.value.match(new RegExp(regex.value, "g"));
                issues = matches ? matches : [];
                return issues;
            }

            function getJql() {
                const jql = issues
                    ? "issuekey in (" + issues.join(", ") + ")"
                    : "";
                return jql;
            }

            function jqlToResults() {
                document.getElementById("jql").value = getJql();
            }

            function copyJql() {
                const jql = document.getElementById("jql");
                jql.select();
                jql.setSelectionRange(0, 99999);
                document.execCommand("copy");
            }

            function updateNumber() {
                document.getElementById("number").innerText = issues.length;
            }

            function updateIssues() {
                const list = document.getElementById("issues");
                list.innerHTML = "";
                for (const issue of issues) {
                    const li = document.createElement("li");
                    li.innerText = issue;
                    list.appendChild(li);
                }
            }

            function decodeTextAndRegexFromUrl() {
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get("text") != null) {
                    const decodedText =
                        globalThis.LZString.decompressFromEncodedURIComponent(
                            urlParams.get("text"),
                        );
                    text.value = decodedText;
                }
                if (urlParams.get("regex" != null)) {
                    const decodedRegex =
                        globalThis.LZString.decompressFromEncodedURIComponent(
                            urlParams.get("regex"),
                        );
                    regex.value = decodedRegex;
                }
            }

            function decodeDimensionsFromUrl() {
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get("width") != null) {
                    const width = parseInt(urlParams.get("width"), 10);
                    if (!isNaN(width)) {
                        text.style.width = width + "px";
                    }
                }
                if (urlParams.get("height") != null) {
                    const height = parseInt(urlParams.get("height"), 10);
                    if (!isNaN(height)) {
                        text.style.height = height + "px";
                    }
                }
            }

            function encodeDimensionsAndAddToUrl() {
                const width = text.offsetWidth.toString();
                const height = text.offsetHeight.toString();
                const currentParams = new URLSearchParams(
                    window.location.search,
                );
                currentParams.set("width", width);
                currentParams.set("height", height);
                window.history.replaceState(
                    null,
                    null,
                    "issue_extractor.html?" + currentParams.toString(),
                );
            }

            function encodeTextAndRegexAndAddToUrl() {
                const encodedText =
                    globalThis.LZString.compressToEncodedURIComponent(
                        text.value,
                    );
                const encodedRegex =
                    globalThis.LZString.compressToEncodedURIComponent(
                        regex.value,
                    );
                const currentParams = new URLSearchParams(
                    window.location.search,
                );
                currentParams.set("text", encodedText);
                currentParams.set("regex", encodedRegex);
                window.history.replaceState(
                    null,
                    null,
                    "issue_extractor.html?" + currentParams.toString(),
                );
            }

            function refresh() {
                findIssues();
                updateIssues();
                updateNumber();
                jqlToResults();
                encodeTextAndRegexAndAddToUrl();
            }

            for (const element of [regex, text]) {
                element.addEventListener("input", () => {
                    refresh();
                });
            }

            text.addEventListener("mouseup", () => {
                encodeDimensionsAndAddToUrl();
            });

            document.addEventListener("DOMContentLoaded", () => {
                exampleText = `V načrtu bomo naredili več stvari.

V prvem delu bomo implementirali zaledje (IX-503940) in UI, ta je že napol narejen v IX-123456.

Potem pa bomo to še testirali v IX-333333 `;
                text.value = exampleText;

                decodeTextAndRegexFromUrl();
                decodeDimensionsFromUrl();
                refresh();
            });
        </script>
    </body>
</html>
