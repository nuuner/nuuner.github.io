<!doctype html>
<html lang="en">

<head>
    <title>Time Tracker</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="compress.min.js"></script>
    <script src="time_tracker.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.5/dist/cdn.min.js"></script>
    <style>
        button {
            background-color: #03cea4;
            border: none;
            border-radius: 5px;
            padding: 5px;
            color: #2a2b3d;
            font-weight: bold;
            margin: 5px;
            cursor: pointer;
        }

        button.grey {
            background-color: #2a2b3d;
            color: #a0a0a0;
        }

        hr {
            border: none;
            border-bottom: solid #2a2b3d 1px;
        }

        input {
            background-color: #2a2b3d;
            border: none;
            border-radius: 5px;
            padding: 5px;
            color: white;
            font-weight: bold;
            margin: 5px;
        }

        .grey {
            color: #a0a0a0;
        }

        body {
            background-color: #1d1e2c;
            color: white;
        }

        a {
            color: #a0a0a0;
        }

        a::visited {
            color: #a0a0a0;
        }

        .trackedProject {
            animation: fadein 0.5s;
            transition-property: transform, opacity;
            transition-duration: 0.3s;
            transition-timing-function: ease-in-out;
        }

        .highlightText {
            animation: green-text-highlight 2s 1;
        }

        @keyframes fadein {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes green-text-highlight {
            0% {
                color: white;
            }

            25% {
                color: #03cea4;
            }

            75% {
                color: #03cea4;
            }

            100% {
                color: white;
            }
        }

        .warningPopup {
            position: absolute;
            top: 0;
            left: 0;
            animation: warningPopupFadeIn 0.5s;
            background-color: #2a2b3d;
            color: #03cea4;
            border: solid #03cea4 2px;
            padding: 10px;
            border-radius: 5px;
            z-index: 100;
        }

        @keyframes warningPopupFadeIn {
            from {
                top: transformY(-100%);
                opacity: 0;
            }

            to {
                top: transformY(0);
                opacity: 1;
            }
        }

        .warning-popup-fade-out {
            animation: warningPopupFadeOut 0.5s;
            opacity: 0;
        }

        @keyframes warningPopupFadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }
    </style>
</head>

<body x-data="{
        project: '',
        id: 0,
        currentId: null,
        tracked: [],
        total: 0,
        date: new Date(),
        deleteTrackedProject: function (trackedProject) {
            const trackedProjectElement = document.getElementById('trackedProject-' + trackedProject.id);
            trackedProjectElement.style.transform = 'translateX(-100%)';
            trackedProjectElement.style.opacity = '0';
            setTimeout(() => {
                this.tracked = this.tracked.filter((trackedProjectInList) => {
                        return trackedProjectInList.id != trackedProject.id;
                    });
                }, 300);
            },
        highlightText: function (selectorString) {
            const element = document.querySelector(selectorString);
            element.classList.add('highlightText');
            setTimeout(() => {
                element.classList.remove('highlightText');
            }, 2000);
        },
        throwWarningPopupBelowOfElement: function (selectorString, text) {
            const element = document.querySelector(selectorString);
            const warningPopup = document.createElement('div');
            warningPopup.classList.add('warningPopup');
            warningPopup.style.top = element.offsetTop + element.offsetHeight + 'px';
            warningPopup.style.left = element.offsetLeft + 'px';
            warningPopup.innerText = text;
            document.body.appendChild(warningPopup);
            setTimeout(() => {
                warningPopup.classList.add('warning-popup-fade-out');
                setTimeout(() => {
                    warningPopup.remove();
                }, 500);
            }, 3000);
        },
        newDate(dateDate, timeDate) {
            const dateDateObject = new Date(dateDate)
            const timeDateObject = new Date(timeDate);
            dateDateObject.setHours(timeDateObject.getHours());
            dateDateObject.setMinutes(timeDateObject.getMinutes());
            dateDateObject.setSeconds(timeDateObject.getSeconds());
            dateDateObject.setMilliseconds(timeDateObject.getMilliseconds());
            return dateDateObject;
        },
        refreshTrackedProjectElement(id) {
            $nextTick(() => {
                const trackedProjectElement = document.getElementById('trackedProject-' + id);
                const trackedProject = this.tracked.find((trackedProject) => {
                    return trackedProject.id == id;
                });

                const commentElement = trackedProjectElement.querySelector('.comment');
                const nameElement = trackedProjectElement.querySelector('.name');
                const startElement = trackedProjectElement.querySelector('.start');
                const endElement = trackedProjectElement.querySelector('.end');
                const durationElement = trackedProjectElement.querySelector('.duration');

                commentElement.innerText = trackedProject.comment;
                nameElement.innerText = trackedProject.name;
                startElement.innerText = trackedProject.start.toTimeString().substring(0,8);
                endElement.innerText = trackedProject.end.toTimeString().substring(0,8);
                durationElement.innerText = getDurationString(trackedProject.start, trackedProject.end);
            });
        },
    }" style="padding: 10px;">
    <div x-data="{
        refreshAllBreaks() {
            tracked.forEach((trackedProject, index) => {
                if (index == tracked.length - 1) {
                    return 0;
                }
                const olderTrackedProject = tracked[index + 1];
                const breakTime = trackedProject.start.getTime() - olderTrackedProject.end.getTime();
                trackedProject.break = breakTime;
            });
        },
        mergeProjects(olderProject, newerProject) {
            newerProject.start = olderProject.start;
            highlightText('#trackedProject-' + newerProject.id + ' .start');
            if (newerProject.comment != olderProject.comment) {
                newerProject.comment = newerProject.comment + '\n\n' + olderProject.comment;
                document.getElementById('trackedProject-' + newerProject.id).querySelector('.comment').innerText = newerProject.comment;
                highlightText('#trackedProject-' + newerProject.id + ' .comment');
            }
            deleteTrackedProject(olderProject);
            },
        isValidTimestamp(timeString) {
            return /^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$/.test(timeString);
        },
        checkIfEndDateIsValid(trackedProject, index, newEndDate) {
            if (newEndDate < trackedProject.start) {
                throwWarningPopupBelowOfElement('#trackedProject-' + trackedProject.id + ' .end', 'End time cannot be before start time');
                return false;
            }
            if (newEndDate > newDate(date, new Date())) {
                throwWarningPopupBelowOfElement('#trackedProject-' + trackedProject.id + ' .end', 'End time cannot be in the future');
                return false;
            }
            if (index != 0) {
                const newerProject = this.tracked[index - 1];
                if (newEndDate > newerProject.start) {
                    throwWarningPopupBelowOfElement('#trackedProject-' + trackedProject.id + ' .end', 'New end time cannot be after start time of a newer project');
                    return false;
                }
            }
            return true;
        },
        checkIfStartDateIsValid(trackedProject, index, newStartDate) {
            if (newStartDate > newDate(date, new Date())) {
                throwWarningPopupBelowOfElement('#trackedProject-' + trackedProject.id + ' .start', 'Start time cannot be in the future');
                return false;
            }
            if (index != this.tracked.length - 1) {
                const olderProject = this.tracked[index + 1];
                if (newStartDate < olderProject.end) {
                    throwWarningPopupBelowOfElement('#trackedProject-' + trackedProject.id + ' .start', 'New start time cannot be before end time of an older project');
                    return false;
                }
            }
            return true;
        },
        getDateTruncatedToSeconds(dateToTruncate) {
            return new Date(dateToTruncate.getTime() - (dateToTruncate.getTime() % 1000));
        },
        updateTrackedProjects() {
            if (!localStorage.getItem(formatDate(date))) {
                tracked = [];
            } else {
                tracked = JSON.parse(localStorage.getItem(formatDate(date)));
            }
            currentId = null;
            id = this.tracked.reduce((acc, trackedProject) => {
                return Math.max(acc, trackedProject.id);
            }, 0) + 1;
            tracked.forEach((trackedProject) => {
                trackedProject.end = newDate(date, trackedProject.end);
                trackedProject.start = newDate(date, trackedProject.start);
            });
        },
        swapProjectUp(index) {
            const newerProject = this.tracked[index - 1];
            const olderProject = this.tracked[index];
            const breakLength = newerProject.start - olderProject.end;
            const newerProjectLength = newerProject.end - newerProject.start;
            const olderProjectLength = olderProject.end - olderProject.start;

            const newerProjectStart = newDate(date, olderProject.start)
            const newerProjectEnd = newDate(date, newerProjectStart.getTime() + newerProjectLength);
            const olderProjectStart = newDate(date, newerProjectEnd.getTime() + breakLength);
            const olderProjectEnd = newDate(date, olderProjectStart.getTime() + olderProjectLength);

            const newerProjectId = newerProject.id;
            const newerProjectComment = newerProject.comment;
            const newerProjectName = newerProject.name;

            newerProject.start = olderProjectStart;
            newerProject.end = olderProjectEnd;
            newerProject.comment = olderProject.comment;
            newerProject.name = olderProject.name;
            newerProject.id = olderProject.id;

            olderProject.start = newerProjectStart;
            olderProject.end = newerProjectEnd;
            olderProject.comment = newerProjectComment;
            olderProject.name = newerProjectName;
            olderProject.id = newerProjectId;

            refreshTrackedProjectElement(newerProject.id)
            refreshTrackedProjectElement(olderProject.id)

            highlightText('#trackedProject-' + newerProject.id + ' .start');
            highlightText('#trackedProject-' + newerProject.id + ' .end');
            highlightText('#trackedProject-' + olderProject.id + ' .start');
            highlightText('#trackedProject-' + olderProject.id + ' .end');
        },
        addTrackedProject(name, start, end, comment) {
            const newTrackedProject = {
                id: id,
                name: name,
                start: start ? start : newDate(date, new Date()),
                end: end ? end : newDate(date, new Date()),
                comment: comment ? comment : 'Worked on ' + name,
                break: 0,
            };
            tracked.unshift(newTrackedProject);
            return id++;
        },
        }" x-init="
        setInterval(() => {
            if (currentId != null && tracked[0].id != currentId) {
                currentId = null;
                return;
            }
            if (tracked.length > 0 && tracked[0].id == currentId) {
                const currentDate = newDate(date, new Date());
                tracked[0].end = getDateTruncatedToSeconds(currentDate);
            }
            total = tracked.reduce((acc, trackedProject) => {
                if (trackedProject.end) {
                    return acc + (trackedProject.end - trackedProject.start);
                }
                return acc;
            }, 0);
        }, 1000);

        $watch('tracked', (tracked) => {
            refreshAllBreaks();
            if (tracked.length > 0) {
                localStorage.setItem(formatDate(date), JSON.stringify(tracked));
            } else {
                localStorage.removeItem(formatDate(date));
            }
        });

        const trackedFromLocalStorage = JSON.parse(localStorage.getItem(formatDate()));
        if (trackedFromLocalStorage) {
            id = trackedFromLocalStorage.reduce((acc, trackedProject) => {
                return Math.max(acc, trackedProject.id);
            }, 0) + 1;
            trackedFromLocalStorage.forEach((trackedProject) => {
                trackedProject.start = newDate(date, trackedProject.start);
                trackedProject.end = newDate(date, trackedProject.end);
            });
            tracked = trackedFromLocalStorage;
        }
        refreshAllBreaks();
        " style="padding: 10px;">
        <div>
            <input type="text" x-model:value="project" placeholder="Project name..." />
            <button x-on:click="
            currentId = addTrackedProject(project);
            ">
                <i class="bi bi-play-fill"></i>
                <span x-text="formatDate(date) == formatDate() ? 'Start tracking' : 'Track project'">
                </span>
            </button>
            <span style="float: right; text-align: center;">
                <div style="font-size: small;" class="grey">TOTAL</div>
                <div x-text="getDurationStringFromMilliseconds(total)"></div>
            </span>
        </div>
        <hr />
        <div>
            <template x-for="(trackedProject, index) in tracked" :key="trackedProject.id">
                <div>
                    <div class="trackedProject" x-bind:id="'trackedProject-' + trackedProject.id"
                        style="border-radius: 5px; padding: 10px; margin: 5px; background-color: #2a2b3d;"
                        :style="{border: (currentId == trackedProject.id ? 'solid #03cea4 2px' : '')}">
                        <div>
                            <span x-show="currentId == trackedProject.id">
                                <button x-on:click="currentId = null">
                                    <i class="bi bi-stop-fill"></i>
                                    <span>Stop tracking</span>
                                </button>
                            </span>
                            <span x-show="index == 0 && currentId != trackedProject.id">
                                <button x-on:click="currentId = trackedProject.id">
                                    Continue tracking
                                    <strong>without</strong> break
                                </button>
                                <button x-on:click="
                                        currentId = addTrackedProject(
                                            trackedProject.name,
                                            getDateTruncatedToSeconds(newDate(date, new Date())),
                                            newDate(date, new Date()),
                                            trackedProject.comment
                                        );
                                        ">
                                    Continue tracking
                                    <strong>with</strong> break
                                </button>
                            </span>
                            <span x-show="index != 0 && currentId != trackedProject.id">
                                <button x-on:click="
                                    currentId = addTrackedProject(
                                        trackedProject.name,
                                        getDateTruncatedToSeconds(newDate(date, new Date())),
                                        newDate(date, new Date()),
                                        trackedProject.comment
                                    );
                                ">
                                    Continue tracking
                                </button>
                            </span>
                            <span x-show="currentId != trackedProject.id" style="float: right;"
                                x-data="{confirm: false}">
                                <button x-show="confirm == false" x-on:click="confirm = true">
                                    <i class="bi bi-trash-fill"></i>
                                    <span>Delete</span>
                                </button>
                                <span x-show="confirm == true">
                                    <button class="grey" x-on:click="confirm = false">
                                        Cancel
                                    </button>
                                    <button x-on:click="
                                            deleteTrackedProject(trackedProject);
                                            confirm = false;
                                        ">
                                        Confirm
                                    </button>
                                </span>
                        </div>
                        <div class="name" contenteditable="true" x-init="$el.innerText = trackedProject.name"
                            spellcheck="false" x-on:input="trackedProject.name = $event.target.innerText"
                            style="font-weight: bold; font-size: 24px"></div>
                        <div style="display: flex; flex-direction: row">
                            <div style="
                                    flex-shrink: 0;
                                    padding-right: 10px;
                                    border-right: solid white 1px;
                                ">
                                <template x-if="trackedProject.end">
                                    <div>
                                        <div>
                                            <span class="end" contenteditable="true"
                                                x-init="$el.innerText = trackedProject.end.toTimeString().substring(0,8)"
                                                x-on:blur="
                                                    if (!isValidTimestamp($event.target.innerText)) {
                                                        $event.target.innerText = trackedProject.end.toTimeString().substring(0,8)
                                                        throwWarningPopupBelowOfElement('#trackedProject-' + trackedProject.id + ' .end', 'Invalid time format');
                                                    } else {
                                                        const newEndDate = newDate(date, trackedProject.end.toDateString() + ' ' + $event.target.innerText);
                                                        if (checkIfEndDateIsValid(trackedProject, index, newEndDate)) {
                                                            trackedProject.end = newEndDate;
                                                            refreshAllBreaks();
                                                        } else {
                                                            $event.target.innerText = trackedProject.end.toTimeString().substring(0,8);
                                                        }
                                                    }
                                                " x-on:click="
                                                    if (trackedProject.id == currentId) {
                                                        throwWarningPopupBelowOfElement('#trackedProject-' + trackedProject.id + ' .end', 'End time cannot be changed while tracking');
                                                        $event.target.blur();
                                                    }
                                                " :style="trackedProject.id == currentId && 'color: #03cea4;'"
                                                x-text="trackedProject.end.toTimeString().substring(0,8)"></span>
                                            <span style="display: inline-block; width: 50px;" class="grey">END</span>
                                        </div>
                                        <div class="duration" style="
                                                border-left: solid white 1px;
                                                padding-left: 10px;
                                            " x-text="getDurationString(trackedProject.start, trackedProject.end)">
                                        </div>
                                    </div>
                                </template>
                                <div>
                                    <span class="start" contenteditable="true"
                                        x-init="$el.innerText = trackedProject.start.toTimeString().substring(0,8)"
                                        x-on:blur="
                                            if (!isValidTimestamp($event.target.innerText)) {
                                                $event.target.innerText = trackedProject.start.toTimeString().substring(0,8)
                                                throwWarningPopupBelowOfElement('#trackedProject-' + trackedProject.id + ' .start', 'Invalid time format');
                                            } else {
                                                const newStartDate = newDate(date, trackedProject.start.toDateString() + ' ' + $event.target.innerText);
                                                if (checkIfStartDateIsValid(trackedProject, index, newStartDate)) {
                                                    trackedProject.start = newStartDate;
                                                    refreshAllBreaks();
                                                } else {
                                                    $event.target.innerText = trackedProject.start.toTimeString().substring(0,8);
                                                }
                                            }
                                        " x-text="trackedProject.start.toTimeString().substring(0,8)"></span>
                                    <span style="display: inline-block; width: 50px;" class="grey">START</span>
                                </div>
                            </div>
                            <div class="comment" style="margin-left: 10px; flex-grow: 1" contenteditable="true"
                                spellcheck="false" x-init="$el.innerText = trackedProject.comment"
                                x-on:focus="if (trackedProject.comment == 'Worked on ' + trackedProject.name) {trackedProject.comment = ''; $el.innerText = trackedProject.comment}"
                                x-on:blur="if (trackedProject.comment.trim() == '') { trackedProject.comment = 'Worked on ' + trackedProject.name; $el.innerText = trackedProject.comment}"
                                x-on:input="trackedProject.comment = $event.target.innerText"></div>
                            <div class="extra-buttons" style="flex-shrink: 0; margin-left: 10px;">
                                <button x-show="index != 0" class="grey" x-on:click="swapProjectUp(index)">
                                    <i class="bi bi-arrow-up"></i>
                                </button>
                                <br>
                                <button x-show="index != tracked.length - 1" class="grey"
                                    x-on:click="swapProjectUp(index + 1)">
                                    <i class="bi bi-arrow-down"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div x-show="trackedProject.break && trackedProject.break > 1000">
                        <div x-data="{ breakOptions: false }" style="border-radius: 5px; padding: 10px; margin: 5px; ">
                            <div>
                                <span x-text="getDurationStringFromMilliseconds(trackedProject.break)"></span>
                                <span class="grey">BREAK</span>
                                <button class="grey" x-on:click="
                                    if (trackedProject.name == tracked[index + 1].name) {
                                        mergeProjects(tracked[index + 1], trackedProject);
                                    } else {
                                        breakOptions = true
                                    }
                                    " x-show="breakOptions == false">
                                    Remove break
                                </button>
                                <span x-show="breakOptions">
                                    <button x-on:click="
                                            let middle = newDate(date, tracked[index + 1].end.getTime() + (trackedProject.start - tracked[index + 1].end) / 2);
                                            trackedProject.start = middle;
                                            tracked[index + 1].end = middle;
                                            highlightText('#trackedProject-' + trackedProject.id + ' .start');
                                            highlightText('#trackedProject-' + tracked[index + 1].id + ' .end');
                                            refreshAllBreaks();
                                        ">
                                        <i class="bi bi-arrows-collapse"></i>
                                    </button>
                                    <button x-on:click="
                                            trackedProject.start = tracked[index + 1].end; breakOptions = false;
                                            highlightText('#trackedProject-' + trackedProject.id + ' .start');
                                            refreshAllBreaks();
                                        ">
                                        <i class="bi bi-arrow-bar-down"></i>
                                    </button>
                                    <button x-on:click="
                                            tracked[index + 1].end = trackedProject.start; breakOptions = false;
                                            highlightText('#trackedProject-' + tracked[index + 1].id + ' .end');
                                            refreshAllBreaks();
                                        ">
                                        <i class="bi bi-arrow-bar-up"></i>
                                    </button>
                                    <button class="grey" x-on:click="breakOptions = false">
                                        Cancel
                                    </button>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>
        <div>
            <span>
                <input type="date" :value="formatDate()" autocomplete="off"
                    x-on:change="date = $event.target.valueAsDate; updateTrackedProjects()">
            </span>
            <button class="grey" x-on:click="console.log(tracked)" style="float: right">
                Print data to console
            </button>
        </div>
    </div>
</body>

</html>
